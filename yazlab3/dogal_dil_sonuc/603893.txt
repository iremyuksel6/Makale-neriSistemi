bayesian likelihood method fit multilevel model complex level1 variat multilevel model common practic assum constant varianc level 1 across individu paper consid situat level1 varianc depend predictor variabl examin two case use dataset educ research first case varianc level 1 test score depend continu intak score predictor second case varianc assum differ accord gender contrast two maximumlikelihood method base iter generalis least squar two markov chain mont carlo mcmc method base adapt hybrid version metropolishast mh algorithm use two simul experi compar four method find four approach good repeatedsampl behaviour class model simul conclud contrast raw logscal formul level1 varianc function find adapt mh sampl consider effici adapt reject sampl heteroscedast model polynomi log scale b introduct past 15 year tting multilevel model data hierarch nest structur becom increasingli common statistician mani applic area eg goldstein 1986 1995 bryk raudenbush 1992 draper 2000 main purpos tting model partit variat respons variabl function level hierarchi relat variabl descript data structur educ exampl multilevel model use calcul proport variat observ explain variabl student class school 3level nest structur randomeect model kind gener combin xedeect model predictor addit relat respons variabl covari gener model assum constant level1 varianc error residu term observ notat student level 1 3level structur reason true applic altern allow heteroscedasticityin word model relat amount level1 variabl predictor variabl refer complex level1 variat heteroscedast common model concern standard tting institut educ univers london 20 bedford way london wc1h 0al uk email bwjsmsrioeacuk wjb hgoldsteinioeacuk hg teuejraioeacuk jr depart mathemat scienc univers bath claverton bath ba2 7ay uk email ddrapermathsbathacuk web httpwwwbathacukmasdd w j brown draper h goldstein j rasbash tabl 1 comparison mean varianc normalis exam score variou partit gcse dataset partit size mean varianc whole dataset 4059 0000 1000 boy 1623 0140 1052 girl 2436 0093 0940 standardis lrt 1 612 0887 0731 05 standardis lrt 01 619 0191 0650 01 standardis lrt 03 710 0044 0658 03 standardis lrt 07 547 0279 0659 07 standardis lrt 11 428 0571 0678 11 standardis lrt 549 0963 0703 linear model data lack hierarch multilevel structur eg weisberg 1985 far less attent paid topic multilevel data main motiv exampl consid dataset studi rasbash et al 2000 origin analys goldstein et al 1993 dataset contain exam result 4059 pupil school sampl six inner london educ author iti respons variabl interest total score achiev gcse examin standardis test taken age 16 pupil variabl alreadi normalis transform replac valu standard normal score dataset consid tabl contain mean varianc estim respons variabl variou partit dataset one main predictor interest score read test lrt pupil took age 11 purpos partit divid pupil 7 group roughli equal sampl size base standardis version lrt score mean column tabl clear girl gener bit better boy lrt score posit correl exam score also seen boy exam score slightli variabl girl score varianc exam score bear roughli quadrat relationship lrt score conclus mean tting multilevel model dataset worth consid need complex variat level 1 plan paper follow section 2 describ two variat maximumlikelihood approach tting multilevel model complex level1 variat examin sever exampl complex varianc structur section 3 4 present markov chain mont carlo mcmc method bayesian tting model base adapt metropolishast sampl use two dierent propos distribu tion section 5 give result two simul studi investig bia interv coverag properti repeat sampl four tting method describ previou three section section 6 examin altern mcmc method b formul complex varianc structur section 7 discuss conclus suggest extens work present fit multilevel model complex level1 variat 3 maximumlikelihoodbas method complex varianc structur begin describ gener 2level model complex variat later section examin method altern gener model addit constraint ad basic structur gener gaussian multilevel model n n x v n 1 vector respons necessarili independ distribut p f 1 vector xedeect coecient predictor n n total number level1 observ data set 4059 student exampl section 1 p f number xed eect model n n covari matrix v respons contain random structur model twolevel case write varianc term v level2 unit j express varianc partit separ term two level e u denot random eect level 1 2 respect covari respons form v iji two observ level2 unit v iji mean vector order observ level2 unit group togeth v block diagon form gener formul level1 level2 varianc covari potenti dierent pair observ import special case exist simpler structur eg variancecompon model level1 level 2 varianc constant across observ covari x may make appear random structur model lead partit uij exampl randomslop regress model singl predictor x 1ij uij u11 u consist varianc covari term level 2 express matrix structur zero nece sari use notat gener withinblock covari term written vector predictor languag section refer earlier complex variat level 1 simpli mean partit level1 varianc depend natur way predictor variabl figur 1 present sever potenti varianc structur tted gcse dataset describ earlier correspond model eij uij eij uij eij 4 w j brown draper h goldstein j rasbash standardis lrt score levelvari model 2 standardis lrt score varianc level 1 varianc level 2 varianc standardis lrt score varianc level 1 varianc level 2 varianc standardis lrt score varianc model 5 level 1 varianc boy level 1 varianc girl level 2 varianc figur 1 four dierent varianc structur tted gcse dataset uij eij model x 1 refer standardis lrt score x 2 refer gender code 0 boy 1 girl equat 2 simpl onelevel regress model quadrat varianc relationship lrt model involv tting increasingli complex varianc structur data twolevel framework one approach tting model 25 via maximum likelihood ml base iter generalis least squar igl restrict variant rigl also known reml correct bia basic idea similar em algorithm estim 1 obtain use current estim v b estim v obtain use iglsrigl estim fit multilevel model complex level1 variat 5 tabl 2 igl estim model 25 tted gcse dataset standard error se parenthes model paramet 2 3 4 5 u00 0094 0018 0091 0018 0086 0017 u01 0019 0007 0020 0007 u11 0014 0004 0015 0004 e12 0032 0013 e22 0058 0026 covari matrix v recast regress problem weight least squar use step see goldstein 1986 1989 detail tabl estim obtain model 25 appli gcse data gender lrt score evid use predict gcse score model 2 naiv ignor hierarch natur data hint heteroscedast ml estim e11 big standard error se estim u00 equat 35 clear need twolevel model full complex requir describ data come focu model 5 everi estim least 22 time larg se 3 mcmc method gener 2level gaussian model complex level1 variat brown draper 2000a 2000b gave gibbssampl algorithm bayesian tting 2level variancecompon randomslopesregress model respect section consid gener 2level model complex variat level 1 easili generalis nlevel model via approach similar method detail brown 1998 mcmc tting model 1 use rewrit follow ij denot scalar outcom level1 observ level2 unit 0 0 e p f 1 p 2 1 p 1 1 vector xedeect paramet level2 level1 residu vector predictor valu p 1 p 2 number paramet specifi random eect level 1 2 respect iglsrigl method directli estim estim tting model use method given 6 w j brown draper h goldstein j rasbash goldstein 1995 equat 6 e u varianc term level 1 level gibb sampl procedur tting multilevel model 6 proceed smoothli treat level2 residu latent variabl form full condit posterior distribut multilevel model simpl homoscedast variat level 1 level1 residu may calcul iter subtract model explicitli comput individu level1 residu instead deal composit residu x c calcul subtract import part algorithm follow store composit level1 varianc function individu paramet depend level1 covari matrix e individu varianc mean algorithm follow apart updat step e almost ident algorithm model without complex variat brown 1998 31 inversewishart propos level1 covari matrix rst mcmc method examin paper collect togeth term varianc equat level 1 eij covari matrix e updat e use metropolishast mh algorithm therefor requir propos distribut gener positivedenit matric later relax restrict use inversewishart propos distribut expect current estim e iter gener e parameteris use exampl gelman carlin et al 1995 inversewishart distribut w 1 expect e w posit integ degre freedom paramet produc distribut expect e paramet w tune constant may set integ valu give desir mh accept rate prior distribut paramet model 6 make follow choic algorithm gener prior e speci section 42 level1 covari matrix inversewishart prior level2 covari matrix multivari normal prior n p f xed eect paramet vector algorithm detail appendix hybrid gibb mh step divid paramet latent variabl 6 four block use multivari normal gibb updat u j inversewishart gibb updat u inversewishart mh propos e 32 adapt method choos tune constant w brown draper 2000b describ adapt hybrid metropolisgibb sampler tting randomeect logist regress model gibb sampl may use model varianc paramet metropoli updat need xed eect latent residu brown draper employ seri univari normal propos distribut pd quantiti give procedur adapt choic appropri fit multilevel model complex level1 variat 7 tabl 3 illustr adapt mh procedur model 4 appli gcse data accept within iter rate w toler 100 20 138 0 200 19 195 0 300 30 208 1 500 30 229 3 valu varianc pd achiev ecient mh accept rate provid modic procedur case inversewishart propos set tune paramet w describ arbitrari start valu exampl follow 100 run algorithm batch 100 iter goal achiev accept rate level1 covari matrix lie within speci toler interv r compar empir accept rate r current batch 100 iter toler interv modifi propos distribut appropri proceed next batch 100 modic perform end batch follow r r integ part w use 8 amount w alter iter procedur increas function distanc r r adapt procedur end three success r valu lie within toler interv valu w xed proceed usual burnin monitor period 33 exampl consid model section 2 quadrat relationship varianc lrt predictor model 4 adapt procedur run model target accept rate base recommend gelman robert gilk 1995 toler summaris progress adapt method exampl 500 iter requir adjust propos distribut give desir accept rate 5002000 iter typic need applic examin tabl 4 compar estim produc mcmc method model 4 igl rigl procedur b anoth mcmc method describ next section throughout paper mcmc point estim posterior mean use slightli inform inversewishart prior level2 covari matrix mcmc method base rigl estim uniform prior level1 covari matrix case result method fairli similar one except paramet e11 notic larger use mcmc 8 w j brown draper h goldstein j rasbash tabl 4 paramet estim four method tting model 4 london school dataset sesposterior standard deviat parenthes mcmc method monitor 50000 iter adapt procedur burnin 500 iter mcmc method paramet igl rigl 1 2 method 1 dierenc highlight fact rst mcmc approach actual ts model extra positivedenit constraint forc e11 posit ate point estim second mcmc method consid base dierent constraint examin chain valu produc e11 found nearli 40 valu neg inconsist result model examin next section e11 varianc 4 truncat normal propos level1 varianc func tion inversewishart updat method assum varianc function level 1 aris positivedenit covari matrix consid altern method manner similar igl rigl requir varianc level 1 linear function paramet mcmc solut still constraint igl solut still consid level1 level2 varianc separ quantiti must posit constraint use mcmc method 1 covari matrix level 1 positivedenit actual stronger necessari positivedenit matric guarante vector x c ij produc posit varianc equat 6 milder still scientic reason constraint allow valu e j restrict appear complic work consid paramet e separ assum variabl xed constraint becom manag use rewrit model 1 time follow e 0 e eij given equat 7 composit level1 residu e normal distribut varianc depend predictor consequ fit multilevel model complex level1 variat 9 constraint level1 varianc alway posit still satis e need positivedenit 41 mh updat method 2 second method ident rst u j appendix involv hast updat dierent propos distribut e updat paramet level1 varianc equat turn alway requir j everi iter markov chain 0 10 consid rst diagon term ekk c x c kth element vector x c ij equival requir c use normal propos distribut varianc 2 kk reject gener valu fail satisfi 12 amount use truncat normal propos shown figur 2i hast ratio r calcul ratio two truncat normal distribut shown figur 2i ii let valu ekk time propos valu time kk kk updat step follow ekk probabl min4 ekk otherwis correspond densiti denomin 14 given 28 diagon term special case alway multipli posit quantiti varianc equat propos distribut need one truncat point gener nondiagon term ekl get follow time j constraint 10 must satis 1 k l p 1 rewritten ekl c c ekl w j brown draper h goldstein j rasbash iv figur 2 plot truncat univari normal propos distribut paramet current valu c b propos new valu max min truncat point distribut iii mean c distribut ii iv mean equival two constraint j x c ekl min ekl min ij j x c use normal propos distribut time varianc 2 kl valu fail satisfi 16 reject lead truncat normal propos shown figur 2iii hast ratio r simpli ratio two truncat normal distribut shown figur 2iii iv let valu ekl time fit multilevel model complex level1 variat 11 propos valu time kl kl min ekl kl kl updat step similar 14 subscript kl place kk e term 42 propos distribut varianc prior distribut method outlin consid paramet e separ mean use separ truncat univari normal propos distribut paramet subject constraint valu gener produc posit level1 varianc eij j therefor need choos propos distribut varianc paramet two possibl solut use varianc paramet estim rigl procedur multipli suitabl posit scale factor use adapt approach burnin monitor run simul see brown draper 2000a descript method case random eect logist regress model prior distribut use method must take account constraint impos paramet analys perform paper method use seri margin uniform prior level1 varianc term subject constraint word valid combin paramet estim e priori equal like prior distribut may problemat 43 exampl model 4 tted gcse data section 33 estim produc mcmc method shown tabl 4 truncat normal method use adapt mh procedur case desir accept rate 50 paramet updat separ advantag truncat normal method handl varianc function would necessarili positivedenit matrix form illustr consid simpl case inversewishart method model follow model includ varianc boy term repres dierenc varianc boy girl result tting model given tabl 5 method give roughli estim level1 varianc term total varianc produc model similar valu given part tabl 1 varianc respons calcul boy girl separ 12 w j brown draper h goldstein j rasbash tabl 5 paramet estim three method tted model 18 gcse dataset method 2 use truncat normal propos monitor 50000 iter follow adapt period burnin 500 iter mcmc paramet igl rigl method 2 5 simul studi section examin bia intervalcoverag properti repeat sampl four method describ two set simul model complex level variat base gcse exampl rst consid model 4 featur quadrat varianc relationship input read test lrt predictor true popul paramet simul use valu close estim obtain actual data one except increas e11 correl random eect level 1 reduc sampl dataset drawn multilevel model high correl caus converg problem igl rigl method brown draper 2000b one thousand dataset gener randomli accord model 4with number level1 level2 unit 4069 65 respect origin gcse data set distribut level1 observ within level2 unitsand tted use four method result present tabl 6 mcmc method simul studi posterior distribut dataset monitor 10000 iter adapt period burnin 500 igl start valu uniform prior use level1 varianc xed eect slightli inform inversewishart prior use level2 covari matrix line result brown draper 2000b interv estim nomin level 1001 igl rigl approach form base largesampl normal approxim user multilevel packag mlwin rasbash et al 2000 hlm bryk et al 1988 would report report interv estim sinc packag routin report estim standard error maximumlikelihood method bayesian mcmc method give result base posterior mean point estim 9095 central posterior interv second simul studi tabl 7 base model 18 section 43 male femal subsampl dierent level1 varianc mcmc method 1 avail model creat 1000 simul dataset popul valu similar estim obtain gcse dataset bayesian approach tting uniform prior use level1 varianc xed eect fit multilevel model complex level1 variat 13 tabl summari result rst simul studi lrt score random level 1 2 bia result rel except bracket absolut true valu case zero mont carlo standard error se given parenthes mont carlo se estim interv coverag b rang 07 10 rel bia point estim paramet mcmc mcmc ftrue valueg igl rigl method 1 method 2 u00 f01g 181 059 008 060 279 062 279 062 b interv coverag probabl nomin level 9095 mcmc mcmc paramet igl rigl method 1 method 2 u00 894931 907936 911960 911960 u01 900944 903946 887941 888941 e00 907941 907941 902941 909948 e11 906951 907951 900950 909954 c mean interv width nomin level 9095 mcmc mcmc paramet igl rigl method 1 method 2 14 w j brown draper h goldstein j rasbash tabl 7 summari result second simul studi separ varianc level 1 boy girl mont carlo standard error se given parenthes mont carlo se estim interv coverag b rang 07 10 rel bia point estim paramet mcmc ftrue valueg igl rigl method 2 b interv coverag probabl nomin level 9095 mcmc paramet igl rigl method 2 u00 883925 892934 900953 c mean interv width nomin level 9095 mcmc paramet igl rigl method 2 fit multilevel model complex level1 variat 15 1 prior use level2 varianc paramet line result brown draper 2000a evid tabl 6 7 four method perform reason well model rigl succeed reduc alreadi small bias aris igl estim case rel bias mcmc method also small rang 0 48 median absolut valu 15 interv coverag four method close nomin actual coverag rang 86 91 9196 nomin 90 95 respect four method achiev level coverag interv compar length ratio 95 90 interv length method close valu 1 0975 expect normal ml method clear advantag speed origin gcse data set iglsrigl mcmc method 1 2 took 2 168 248 second 500mhz pentium pc respect mcmc method base 10000 monitor iter ml approach two potenti disadvantag data set small number level1 level2 unit requir sophist method construct interv estim varianc paramet achiev good coverag properti largesampl normal approxim use brown draper 2000ab may fail converg e andor matric exhibit high degre correl paramet quantifi random eect bayesian method consider slower addit advantag infer arbitrari function model paramet automat model paramet monitor 6 mcmc method 61 gibb sampl special case problem complex level1 variat tted use standard gibb sampler model equat 18 use second simul use dierent level1 varianc term gender one exampl could reparameteris model two varianc one boy 2 b one girl rather boy varianc plu dierenc scaledinvers 2 prior see eg gelman et al 1995 use two varianc paramet respect divid children boy girl subgroup b g size n b n g step 3 algorithm given appendix rewritten two gibb sampl step follow full condit 2 b full condit 2 g exactli analog level1 varianc step algorithm 62 model varianc log scale develop softwar packag bug spiegelhalt et al 1997 use dierent approach tting complex level1 variat one exampl school data w j brown draper h goldstein j rasbash set exampl 9 volum 2 spiegelhalt et al 1996 model logarithm level1 precis function predictor paramet 0 result multipl rather addit varianc function exp advantag approach paramet unconstrain level varianc never neg easier specifi prior method disadvantag interpret individu coecient easi comput model slower interpret diculti appar mainli x variabl categor model 20 tted bug use adapt reject ar sampl gilk wild 1992 altern adapt mh method use truncat normal algorithm section 41 use time paramet constraint henc truncat normal propos distribut goldstein 1995 appendix 51 show obtain ml estim model see yang et al 2000 set mlwin macro explor dierenc logvari model earlier approach tted four dierent level1 varianc function gcse dataset model eect lrt score x 1 level1 varianc consid quadrat relationship examin earlier model 4 simpler linear relationship eij also consid two exponenti relationship four model level2 varianc structur xed eect equat 4 figur 3 plot result level1 estim varianc function lrt score case major data varianc estim produc four model fairli similar discrep model occur extrem lrt rang rel observ tabl present estim four model use mh method 2 togeth rafterylewi 1992 default diagnost mh ar sampl exponenti model 23 compar time part b tabl evid paramet worst mcmc mix intercept 0 mean although mh method requir longer monitor run ar approach fit multilevel model complex level1 variat 17 standardis lrt score levelvari quadrat exp linear exp quadrat figur 3 four way model eect standardis lrt score level1 varianc gcse dataset level1 varianc paramet run length requir ensur paramet estim speci accuraci respect 95 interv estim roughli equal part c tabl seen mh approach 49 time faster realtim execut speed exampl result tabl 8 base singl data set typic nding obtain similar model 7 conclus extens paper present sever method model nonconst level1 varianc function multilevel data introduc two new adapt metropolishast sampl method tting function subject dierent constraint two method give similar estim model true paramet valu aect constraint true valu satisfi addit posit denit matrix constraint inversewishart propos method estim two method dier main advantag inversewishart method model level1 varianc function matrix manner analog usual treatment level2 varianc function mean among thing inform inversewishart prior level 1 use approach main advantag truncat normal propos method gener deal varianc function level w j brown draper h goldstein j rasbash tabl 8 paramet estim four dierent level1 varianc function appli gcse dataset mcmc method use monitor period 50000 iter burnin 500 iter method adapt mh step level run use develop version mlwin adapt reject ar step level 1 run winbug posterior standard deviat given parenthes paramet estim exponenti exponenti paramet linear quadrat linear quadrat e11 0003 0009 00005 0016 b rafterylewi valu thousand iter main entri appli mh method 2 correspond valu ar parenthes exponenti exponenti n linear quadrat linear quadrat u00 43 43 44 43 43 41 e11 169 156 46 c time minut 500 pentium mhz exponenti exponenti method linear quadrat linear quadrat metropolishast 19 20 23 25 adapt reject 95 227 fit multilevel model complex level1 variat 19 1 method bia interv coverag properti similar maximumlikelihood igl rigl approach four method perform satisfactorili repeat sampl regard section 62 consid altern formul level1 varianc function term log precis level 1 method two advantag need impos constraint term result varianc function therefor easier contempl varieti prior distribut result varianc paramet main disadvantag approach individu term varianc function may easili interpret make potenti dicult construct sensibl inform prior tabl 8 show clearli howev adapt reject sampl much less ecient adapt metropolishast sampl achiev default mcmc accuraci standard varianc precis function exponenti paramet two obviou extens work arbitrari varianc structur higher level multivari normal respons two approach tting random eect level 2 appear common current appli work model random eect independ tting fulli depend random eect complet covari matrix level see birat exampl spiegelhalt et al 1996 illustr formul fairli easi blockdiagon covari structur higher level use gibb sampl straightforward extens approach given section 61 adapt mh sampler truncat normal propos method 2 section 41 use depend structur among random eect higher level includ non blockdiagon covari matric multivari normal respons model varianc function lowest level includ varianc respons plu covari respons varianc function could also extend includ predictor may uenc varianc individu respons analog way univari model intend report mcmc sampl algorithm gener multivariaterespons multilevel model elsewher acknowledg grate epsrc esrc european commiss nancial support david spiegelhalt nicki best particip bug project refer comment set multilevel model paper base rst author phd dissert membership list impli agreement idea express peopl respons error may present appendix detail mcmc method 1 step 1 algorithm describ section 31 full condit distribut gibb updat xed eect paramet vector multivari normal p f w j brown draper h goldstein j rasbash number xed eect eij eij involv gibb updat level2 residu u j also multivari normal full condit distribut p 2 number paramet describ random eect level2 n j number level1 unit level2 unit j pn eij pn eij step 3 employ hast updat use inversewishart propos distribut level1 covari matrix e specic markov chain move e time e follow e probabl min e e e otherwis e w 1 e w chosen section 32 p 1 number row column b hast ratio r 26 exp tr e e tr e c full condit distribut e 26 1eij exp express righthand side 28 conveni term eij equat 7 final step 4 involv gibb updat level2 covari matrix express ofu full condit e number row column u j number level2 unit data set improp uniform prior u correspond choic fit multilevel model complex level1 variat 21 r appli mcmc method multilevel model bryk bryk bayesian hierarch model bayesian data analysi adapt reject sampl gibb sampl multilevel mix linear model analysi use iter generalis least squar restrict unbias iter generalis least squar estim multilevel statist model second edit multilevel analysi school examin result mani iter gibb sampler user guid mlwin version 21 bug 05 exampl version ii cambridg medic research council biostatist unit bug bayesian infer use gibb sampl version 060 appli linear regress mlwin macro advanc multilevel model version 20 tr